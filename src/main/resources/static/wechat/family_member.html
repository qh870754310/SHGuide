<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>家庭成员</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <meta content="yes" name="apple-mobile-web-app-capable"/>
    <meta content="black" name="apple-mobile-web-app-status-bar-style"/>
    <meta content="telephone=no" name="format-detection"/>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../resources/path/build/plugins/vue-ydui/dist/ydui.rem.css">
    <!-- 引入rem自适应类库 -->
    <link rel="stylesheet" href="../resources/path/build/plugins/ydui-0.1.3/build/css/ydui.css?rev=a4b9d6e8c9c1cae7ea4676f911682af7"/>
    <link rel="stylesheet" href="../resources/path/build/plugins/ydui-0.1.3/demo/css/demo.css"/>
    <script src="../resources/path/build/plugins/ydui-0.1.3/build/js/ydui.flexible.js"></script>
    <script src="../resources/path/build/js/vue.min.js"></script>
    <style>
        .cell-icon {
            color: red;
            margin-right: 0.1rem;
            margin-top: 0.2rem;
            margin-left: 0.1rem;
        }
        .cell-select {
            color: #555;
        }
    </style>
</head>
<body>
<section class="g-flexview">

    <header class="m-navbar">
        <a href="family_member_list.html" class="navbar-item"><i class="back-ico"></i></a>
        <div class="navbar-center"><span class="navbar-title">家庭成员</span></div>
    </header>

    <section class="g-scrollview" id="rrapp" v-cloak>
        <div class="m-celltitle demo-small-pitch">家庭成员基本信息</div>
        <form class="form-horizontal">
        <div class="m-cell demo-small-pitch">
            <div class="cell-item" style="display: none">
                <div class="cell-left">学生基本信息id<i class="cell-icon">*</i></div>
                <div class="cell-right"><input type="text" id="studentId" v-model="shFamilyMember.studentId" class="cell-input" autocomplete="off" required/></div>
            </div>
            <div class="cell-item">
                <div class="cell-left">亲属关系<i class="cell-icon">*</i>：</div>
                <label class="cell-right cell-arrow">
                    <select class="cell-select" v-model="shFamilyMember.domesticRelation" id="relationship_Id">

                    </select>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">亲属姓名<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.familyName" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">政治面貌：</div>
                <label class="cell-right cell-arrow" >
                    <select class="cell-select" v-model="shFamilyMember.politicalStatus" id="policital_status_Id">

                    </select>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">出生日期<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input class="cell-input" v-model="shFamilyMember.birthday" type="date" id="birthday" placeholder="" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">证件类型<i class="cell-icon">*</i>：</div>
                <label class="cell-right cell-arrow">
                    <select class="cell-select" v-model="shFamilyMember.certificateType" id="certificate_type_Id">

                    </select>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">证件号<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.idCard" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">家庭成员<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.member" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">平均月收入<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.averageMonthlyEarnings" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">健康状况：</div>
                <label class="cell-right cell-arrow" >
                    <select class="cell-select" v-model="shFamilyMember.healthCondition" id="health_status_Id">

                    </select>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">是否监护人：</div>
                <label class="cell-right">
                    <input type="checkbox" class="m-switch-old" v-model="shFamilyMember.guardian" />
                    <span class="m-switch"></span>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">文化程度：</div>
                <label class="cell-right cell-arrow">
                    <select class="cell-select" v-model="shFamilyMember.educationalLevel">
                        <option value="">请选择文化程度</option>
                        <option value="0">小学</option>
                        <option value="1">初中</option>
                        <option value="2">高中</option>
                        <option value="3">专科</option>
                        <option value="4">本科</option>
                        <option value="5">硕士研究生</option>
                        <option value="6">博士研究生</option>
                        <option value="7">博士后</option>
                    </select>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">工作单位<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.company" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">职业<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.profession" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">职务：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.post" class="cell-input" autocomplete="off" /></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">联系地址<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text"  v-model="shFamilyMember.contactAddress" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">邮政编码<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.postalCodes" class="cell-input" autocomplete="off" /></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">手机<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.mobile" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">联系电话<i class="cell-icon">*</i>：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.phone" class="cell-input" autocomplete="off" required/></div>
            </div>

            <div class="cell-item">
                <div class="cell-left">婚姻状况：</div>
                <label class="cell-right cell-arrow" >
                    <select class="cell-select" v-model="shFamilyMember.maritalStatus" id="marital_status_Id">

                    </select>
                </label>
            </div>

            <div class="cell-item">
                <div class="cell-left">备注：</div>
                <div class="cell-right"><input type="text" v-model="shFamilyMember.remark" class="cell-input" autocomplete="off" /></div>
            </div>

        </div>
        <div class="m-button">
            <button type="button" class="btn-block btn-primary" @click="saveOrUpdate">提交</button>
        </div>
        </form>
    </section>
</section>
<script id="J_ListHtml" type="text/html">
    {{if isAdmin}}
           <!-- <select class="cell-select" v-model="{{modelName}}"  {{isRequired}} >-->
            <option value="">请选择{{labelName}}</option>
            {{each list as codeEntity i}}
            <option value="{{codeEntity.id}}">{{codeEntity.name}}</option>
            {{/each}}
        <!--</select>-->
    {{/if}}
</script>
<!-- 引入组件库 -->
<script src="../resources/path/build/js/fastclick.js"></script>
<script src="../resources/path/build/js/template.js"></script>
<script src="../resources/path/build/js/jquery-3.1.1.min.js"></script>
<script src="../resources/path/build/plugins/ydui-0.1.3/build/js/ydui.js"></script>
<script>
    !function (win, $) {

        FastClick.attach(document.body);
        var dialog = win.YDUI.dialog;
        window.apiDomain = 'http://183.195.133.44:81/';

        var now = new Date(),
            year = now.getFullYear(),
            month = ((now.getMonth() + 1)>9)?(now.getMonth() + 1):("0"+(now.getMonth() + 1)),
            date = translate(now.getDate()),
            hour = translate(now.getHours()),
            minute = translate(now.getMinutes()),
            second = translate(now.getSeconds());
        function translate(prop) {
            if (prop <= 9) {
                return "0" + prop;
            } else {
                return prop
            }
        }
        var dateString = year+"-"+month+"-"+date;
        $('#birthday').val(dateString);

        var apiDomain = 'http://183.195.133.44:81';
        var url = apiDomain + '/app/getCodeByMark/';

        function getCode(code) {
            $.ajax({
                url: url + code,
                type: 'GET',
                async: false,
                dataType: 'json',//传递给请求处理程序或页面的,用以获得jsonp回调函数名的参数名(默认为callback)
                success: function (ret) {
                    if (ret.code == 0) {
                        console.log(ret.codeEntitys);
                        var label_title = showLabel(code).split(":")[0];
                        var isRequired = showLabel(code).split(":")[1];
                        var modelName = showLabel(code).split(":")[2];
                        var data = {
                            isAdmin: true,
                            labelName: label_title,
                            list: ret.codeEntitys,
                            isRequired: isRequired,
                            modelName: modelName
                        };
                        var html = template('J_ListHtml', data);
                        $('#' + code + '_Id').append(html);
                    }
                },
                error: function (ret) {
                    alert("服务器连接失败");
                }

            });
        }

        function showLabel(labelInfo) {
            var label_title = "", required="", modelName="";
            switch(labelInfo) {
                case 'relationship':
                    label_title = "亲属关系";
                    required = "required";
                    modelName = "shFamilyMember.domesticRelation";
                    break;
                case 'policital_status':
                    label_title = "政治面貌";
                    required = "";
                    modelName = "shFamilyMember.politicalStatus";
                    break;
                case 'certificate_type':
                    label_title = "证件类型";
                    required = "required";
                    modelName = "shFamilyMember.certificateType";
                    break;
                case 'health_status':
                    label_title = "健康状况";
                    required = "";
                    modelName = "shFamilyMember.healthCondition";
                    break;
                case 'marital_status':
                    label_title = "婚姻状况";
                    required = "";
                    modelName = "shFamilyMember.maritalStatus";
                    break;
            }
            return label_title + ':' + required + ":" + modelName;
        }

        var arr = ['relationship', 'policital_status', 'certificate_type', 'health_status', 'marital_status'];
        for( let i of arr){
            getCode(i);
        }

    }(window, jQuery);

    //获取缓存中登录学生的id
    window.$studentId = localStorage.getItem("studentId");
    //获取登录用户身份证号码
    var $idCard = localStorage.getItem("idCard");

    var vm = new Vue({
        el:'#rrapp',
        data:{
            shFamilyMember: {
                studentId: $studentId,
                domesticRelation: '',
                familyName: '',
                birthday: '',
                certificateType: '',
                idCard: '',
                politicalStatus: '',
                educationalLevel: '',
                company: '',
                profession: '',
                averageMonthlyEarnings: '',
                guardian: '',
                post: '',
                member: '',
                healthCondition: '',
                contactAddress: '',
                postalCodes: '',
                mobile: '',
                phone: '',
                maritalStatus: '',
                remark: ''
            }
        },
        methods: {
            saveOrUpdate: function (event) {
                console.log(JSON.stringify(vm.shFamilyMember));
                var url = "http://183.195.133.44:81/app/saveFamilyMember";
                var url = vm.shFamilyMember.id == null ? "http://183.195.133.44:81/app/saveFamilyMember" : "http://183.195.133.44:81/app/updateFamilyMember";
                //           var url = "http://183.195.133.44:81/app/save" ;
                console.log(vm.shFamilyMember);
                $.ajax({
                    url: url,
                    type: "POST",
                    dataType: 'json',
                    contentType:'application/json;charset=UTF-8',
                    data: JSON.stringify(vm.shFamilyMember),
                    success: function(r){
                        if(r.code == 0){
                            /* 正确提示框 */
                            window.YDUI.dialog.toast(r.msg, 'success', 1000, function () {
                                window.location = 'family_member_list.html'
                            });
                        }else{
                            window.YDUI.dialog.toast(r.msg, 'error', 1000, function () {
                                window.YDUI.dialog.alert('请检查后，重新提交!');
                            });
                        }
                    }
                });
            },
            getInfo: function(id){
                $.get("http://183.195.133.44:81/app/getFamilyMemberById/"+id, function(r){
                    if(r.code == 0){
                        vm.shFamilyMember = r.shFamilyMember;
                    }else{
                        alert(r.msg);
                    }
                });
            }
        }
    });

    if ($studentId) { //若本地存在个人信息，则从本地库查询，否则从远程库查询
        var $familyMemberId = localStorage.getItem("familyMemberId");
        if ($familyMemberId) { //存在，则是查看家庭成员信息，否则是新增家庭成员
            vm.getInfo($familyMemberId);
        }
    } else {
        dialog.toast('很抱歉，用户登录信息已过期，请重新登录', 'error', 3000, function () {
            window.location = 'register_manager.html';
        });
    }
</script>
</body>
</html>